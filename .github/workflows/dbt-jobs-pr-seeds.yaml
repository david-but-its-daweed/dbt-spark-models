name: Reapply DBT Seeds

on:
  push:
    branches:
      - master
    paths:
      - seeds/**

concurrency:
  group: analytics-jobs-dbt-seed
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: eu-central-1
          role-to-assume: arn:aws:iam::392166590300:role/github-hosted-runner
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - uses: azure/setup-kubectl@v1
        with:
          version: 'v1.19.0'
      - name: Login to EKS
        run: aws eks --region eu-central-1 update-kubeconfig --name streaming-kube
      - name: Check out repository code
        uses: actions/checkout@v2
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo apt-get install -y python3-dev libsasl2-dev gcc
      - name: Install DBT
        run: pip3.8 install dbt-core==1.6.0 dbt-spark[PyHive]==1.6.0 urllib3==1.26.6
      - name: Apply DBT seeds
        run: dbt seed --profiles-dir production/adhoc
      - name: Slack Notification
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: analytics-monitoring
          MSG_MINIMAL: Commit
          SLACK_COLOR: ${{ job.status }}
          SLACK_USERNAME: github
          SLACK_TITLE: DBT seed autodeploy failed. Status ${{ job.status }}
