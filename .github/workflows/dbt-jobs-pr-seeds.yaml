name: Reapply DBT Seeds

on:
  push:
    branches:
      - master
    paths:
      - seeds/**

concurrency:
  group: analytics-jobs-dbt-seed
  cancel-in-progress: true

jobs:
  build:
    runs-on: [self-hosted, analytics-platform-dbt-models-spark]
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Ensure Python 3.8
        run: sudo amazon-linux-extras enable python3.8 && sudo yum -y install python3.8
      # Not using setup-python because of https://github.com/actions/setup-python/issues/162
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo yum -y install gcc gcc-c++ python3-devel python38-devel cyrus-sasl-devel
      - name: Install protobuf
        run: pip3.8 install protobuf==4.25.3
      - name: Install DBT
        run: pip3.8 install dbt-core==1.7.6 dbt-spark[PyHive]==1.7.1 urllib3==1.26.6
      - name: Apply DBT seeds
        run: dbt seed --profiles-dir production/adhoc
      - name: Slack Notification
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: analytics-monitoring
          MSG_MINIMAL: Commit
          SLACK_COLOR: ${{ job.status }}
          SLACK_USERNAME: github
          SLACK_TITLE: DBT seed autodeploy failed. Status ${{ job.status }}
