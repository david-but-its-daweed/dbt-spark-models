name: Run DBT model manually
on:
  workflow_dispatch:
    inputs:
      select:
        description: 'Example: --select +my_model_name'
        required: true
      action:
        description: 'Example: run'
        required: true
        default: 'run'

concurrency: run-dbt-model
jobs:
  run:
    runs-on: [self-hosted, analytics-platform-dbt-models-spark]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Exit if the branch is not master
        run: |
          if [[ "${{ github.ref }}" != "refs/heads/master" ]]; then
            echo "Branch is not master, exiting."
            exit 1
          fi
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-central-1
          role-to-assume: arn:aws:iam::392166590300:role/github-hosted-runner
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - uses: azure/setup-kubectl@v3
        with:
          version: 'v1.19.0'
      - name: Login to EKS
        run: aws eks --region eu-central-1 update-kubeconfig --name streaming-kube
      - name: Check out repository code
        uses: actions/checkout@v3
      # Not using setup-python because of https://github.com/actions/setup-python/issues/162
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo yum -y install gcc gcc-c++ python3-devel cyrus-sasl-devel python3-pip
      - name: Install protobuf
        run: pip install protobuf==4.25.3
      - name: Install DBT
        # to fix error
        # ImportError: urllib3 v2.0 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with OpenSSL 1.0.2k-fips  26 Jan 2017. See: https://github.com/urllib3/urllib3/issues/2168
        run: pip install dbt-core==1.7.6 dbt-spark[PyHive]==1.7.1 urllib3==1.26.6
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
      - name: Run model
        run: |
          source infra/functions.sh
  
          DBT_DIR="$( cd -- "$( dirname -- "${BASH_SOURCE[0]:-$0}"; )" &> /dev/null && pwd 2> /dev/null; )";
          
          # Interoperable btw Linux and OSX version of `date -d "<param> day ago" '+%Y-%m-%d'`
          function days_ago {
          PYTHON_AGO_ARG="$1" python3 - <<END
          import os
          from datetime import datetime, timedelta
          ago = int(os.environ['PYTHON_AGO_ARG'])
          ago_date = datetime.now() - timedelta(ago)
          print(ago_date.strftime('%Y-%m-%d'))
          END
          }
          
          DEFAULT_START_DATE=$(days_ago 1)
          DEFAULT_END_DATE=$(days_ago 0)
          DBT_VARS="{'start_date_ymd':'$DEFAULT_START_DATE','end_date_ymd':'$DEFAULT_END_DATE','table_name':'table_name'}"
          
          dbt run --profiles-dir production/adhoc --vars $DBT_VARS ${{ github.event.inputs.select }}
