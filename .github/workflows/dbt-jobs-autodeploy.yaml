name: Autodeploy DBT Jobs
on:
  push:
    branches:
      - master
  workflow_dispatch: {}

concurrency: deploy-custom-1
jobs:
  deploy:
    runs-on: [self-hosted, analytics-platform-dbt-models-spark]
    permissions:
      id-token: write
      contents: read
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-central-1
          role-to-assume: arn:aws:iam::392166590300:role/github-hosted-runner
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - uses: azure/setup-kubectl@v3
        with:
          version: 'v1.19.0'
      - name: Login to EKS
        run: aws eks --region eu-central-1 update-kubeconfig --name streaming-kube
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Checkout reusable workflow dir
        uses: actions/checkout@v3
        with:
          repository: joomcode/dbt-models
          ref: master
          token: ${{ secrets.ACCESS_TOKEN }}
          path: dbt-models-repo
      # Not using setup-python because of https://github.com/actions/setup-python/issues/162
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo yum -y install gcc gcc-c++ python3-devel cyrus-sasl-devel python3-pip
      - name: Install protobuf
        run: pip install protobuf==4.25.3
      - name: Install DBT
        # to fix error
        # ImportError: urllib3 v2.0 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with OpenSSL 1.0.2k-fips  26 Jan 2017. See: https://github.com/urllib3/urllib3/issues/2168
        run: pip install dbt-core==1.7.6 dbt-spark[PyHive]==1.7.1 urllib3==1.26.6
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
      - name: Test DBT project
        run: ./test.sh
      - name: Compile DBT
        run: |
          dbt compile --profiles-dir production/profiles --target prod --vars '{"start_date_ymd": "{start_date}", "end_date_ymd": "{end_date}", "table_name": "{table_name}"}'
      - name: Check all models have owners
        run: python3 .github/scripts/get_no_owner.py
      - name: Check no unused sources
        run: python3 .github/scripts/get_no_owner.py
      - name: Check manual tables
        uses: joomcode/dbt-models/.github/actions/check-manual-tables@master
        with:
          platform: spark
          manual-tables-filepath: seeds/manual_tables_seed.csv
          manifest-filepath: target/manifest.json
          script-filepath: dbt-models-repo/.github/scripts/check_manual_tables.py
      - uses: joomcode/dbt-models/.github/actions/deploy-manifest@master
        with:
          dbt-select: "--exclude tag:manual tag:platform tag:data_readiness"
          job-name: dbt-etl
          crontab: 15 0 * * *
          alerts-channel: "#dbt-spark-monitoring"
          profiles-dir: "production/profiles"
          profile-name: spark
      - uses: joomcode/dbt-models/.github/actions/deploy-manifest@master
        with:
          dbt-select: "--select tag:platform"
          job-name: dbt-platform
          crontab: 15 0 * * *
          alerts-channel: "#analytics-monitoring"
          profiles-dir: "production/profiles"
          profile-name: spark
      - uses: joomcode/dbt-models/.github/actions/deploy-manifest@master
        with:
          dbt-select: "--select tag:data_readiness"
          job-name: data-readiness
          crontab: 0 * * * *
          alerts-channel: "#analytics-monitoring"
          profiles-dir: "production/profiles"
          profile-name: spark
      - name: Create package
        run: |
          tar --exclude="./.git/*" --exclude="*.tar.gz" --exclude="./.idea/*" -zcvf ../dbt-models.tar.gz .
          mv ../dbt-models.tar.gz .

      - name: Upload package
        run: aws s3 cp dbt-models.tar.gz s3://joom-analytics-deploy/airflow/dags/platform__dbt_shared_spark/dbt-models.tar.gz

      - uses: joomcode/dbt-models/.github/actions/deploy-docs@master
        with:
          image-tag: "392166590300.dkr.ecr.eu-central-1.amazonaws.com/dbt-spark-models"
          kube-deployment: "dbt-docs-spark"
          generate-docs: "false"

      - name: Slack Notification
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: dbt-spark-monitoring
          MSG_MINIMAL: Commit
          SLACK_COLOR: ${{ job.status }}
          SLACK_USERNAME: github
          SLACK_TITLE: Deploy of dbt spark jobs failed. Status ${{ job.status }}
