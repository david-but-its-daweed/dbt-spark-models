name: Autodeploy DBT Jobs
on:
  push:
    branches:
      - develop
  workflow_dispatch: {}

concurrency: analytics-jobs-dbt
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Ensure Python 3.8
        run: sudo amazon-linux-extras enable python3.8 && sudo yum -y install python3.8
      # Not using setup-python because of https://github.com/actions/setup-python/issues/162
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo yum -y install gcc gcc-c++ python3-devel python38-devel cyrus-sasl-devel
      - name: Install DBT
        # to fix error
        # ImportError: urllib3 v2.0 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with OpenSSL 1.0.2k-fips  26 Jan 2017. See: https://github.com/urllib3/urllib3/issues/2168
        run: pip3.8 install dbt-core==1.6.0 dbt-spark[PyHive]==1.6.0 urllib3==1.26.6
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
      - name: Test DBT project
        run: ./test.sh
      - name: Compile DBT
        run: |
          dbt compile --profiles-dir deploy/profiles --target prod --vars '{"start_date_ymd": "{start_date}", "end_date_ymd": "{end_date}", "table_name": "{table_name}"}'
      - uses: ./.github/workflows/deploy-manifest-internal/
        with:
          dbt-select: "--exclude tag:manual tag:platform tag:data_readiness"
          job-name: dbt-etl
          crontab: 15 0 * * *
          alerts-channel: "#analytics-monitoring"
      - uses: ./.github/workflows/deploy-manifest-internal/
        with:
          dbt-select: "--select tag:platform"
          job-name: dbt-platform
          crontab: 15 0 * * *
          alerts-channel: "#analytics-monitoring"
      - uses: ./.github/workflows/deploy-manifest-internal/
        with:
          dbt-select: "--select tag:data_readiness"
          job-name: data-readiness
          crontab: 0 * * * *
          alerts-channel: "#analytics-monitoring"
      - name: Create package
        run: tar --exclude="./.git/*" --exclude="*.tar.gz" --exclude="./.idea/*" -zcvf ../dbt-models.tar.gz .
      - name: Upload package
        run: aws s3 cp ../dbt-models.tar.gz s3://joom-analytics-deploy/airflow/dags/platform__dbt_shared_spark/dbt-models.tar.gz
#        fails with   Tables contain columns with the same names (table_owner), but different types (<dbt.clients.agate_helper.Number object at 0x7fadbcddf8e0> vs <agate.data_types.text.Text object at 0x7fadbcb9e9a0>)
#        will fix in dbt-spark later
#      - name: Generate docs
#        run: ./generate_docs_production.sh
#      - name: Push image
#        id: docker_build
#        uses: docker/build-push-action@v2
#        with:
#          file: ./analytics/dbt/Dockerfile
#          push: true
#          tags: 392166590300.dkr.ecr.eu-central-1.amazonaws.com/dbt-models-spark:${{ github.sha }}
#          secrets: |
#            GIT_AUTH_TOKEN=${{ secrets.GITHUB_TOKEN }}
      - name: Slack Notification
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: analytics-monitoring
          MSG_MINIMAL: Commit
          SLACK_COLOR: ${{ job.status }}
          SLACK_USERNAME: github
          SLACK_TITLE: DBT jobs autodeploy failed. Status ${{ job.status }}
