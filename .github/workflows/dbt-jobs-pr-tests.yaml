name: Test PR
on:
  pull_request:
    branches:
      - master

concurrency:
  group: analytics-jobs-prs-dbt-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  sqlfluff:
    uses: joomcode/dbt-models/.github/workflows/sqlfluff-fix-internal@sharing-sqlfluff-fix
    with:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      user-login: ${{ github.event.pull_request.user.login }}
      dialect: sqlspark
  build:
    runs-on: [self-hosted, analytics-platform-dbt-models-spark]
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Ensure Python 3.8
        run: sudo amazon-linux-extras enable python3.8 && sudo yum -y install python3.8
      # Not using setup-python because of https://github.com/actions/setup-python/issues/162
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo yum -y install gcc gcc-c++ python3-devel python38-devel cyrus-sasl-devel
      - name: Install DBT
        run: pip3.8 install dbt-core==1.6.0 dbt-spark[PyHive]==1.6.0 urllib3==1.26.6
      - name: test DBT models
        run: ./test.sh
      - name: SQL fluff fix
        uses: actions/sqlfluff


