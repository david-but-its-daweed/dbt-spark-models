name: Test PR
on:
  pull_request:
    branches:
      - master

concurrency:
  group: analytics-jobs-prs-dbt-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: [self-hosted, analytics-platform-dbt-models-spark]
    steps:
      - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "🐧 This job is now running on ${{ runner.name }}"
      - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Checkout reusable workflow dir
        uses: actions/checkout@v3
        with:
          repository: joomcode/dbt-models
          ref: master
          token: ${{ secrets.ACCESS_TOKEN }}
          path: dbt-models-repo
      - name: Ensure Python 3.8
        run: sudo amazon-linux-extras enable python3.8 && sudo yum -y install python3.8
      # Not using setup-python because of https://github.com/actions/setup-python/issues/162
      - name: Add python installed packages to path
        run: echo "${HOME}/.local/bin" >> $GITHUB_PATH
      - name: Install development tools
        run: sudo yum -y install gcc gcc-c++ python3-devel python38-devel cyrus-sasl-devel
      - name: Install protobuf
        run: pip3.8 install protobuf==4.25.3
      - name: Install DBT
        run: pip3.8 install dbt-core==1.7.6 dbt-spark[PyHive]==1.7.1 urllib3==1.26.6
      - name: test DBT models
        run: ./test.sh
      - name: Check all models have owners
        run: python3 .github/scripts/get_no_owner.py
      - name: Check no unused sources
        run: python3 .github/scripts/get_unused_sources.py
      - name: Check manual tables
        uses: joomcode/dbt-models/.github/actions/check-manual-tables@master
        with:
          platform: spark
          manual-tables-filepath: seeds/manual_tables_seed.csv
          manifest-filepath: target/manifest.json
          script-filepath: dbt-models-repo/.github/scripts/check_manual_tables.py
      - name: SQL fluff fix
        uses: joomcode/dbt-models/.github/actions/sqlfluff-fix@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          user-login: ${{ github.event.pull_request.user.login }}
          dialect: sparksql
          pip: pip3.8
