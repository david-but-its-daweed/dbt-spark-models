models:
  - name: onfy_search_conversion
    description: owner - andrewocean, aggregated dataset on user search to card open, adding to cart or order conversion
    columns:
      - name: search_event_dt
        description: the date of the users searches
      - name: search_event_date
        description: tech date field for partitioning
      - name: search_event_id
        description: id of a search
      - name: search_query
        description: the query (aka words) from the search bar, manual or chosen from suggest
      - name: is_category_search
        description: the flag of categorized search
      - name: has_product_results
        description: flag of search with actual results listing or empty results
      - name: is_suggest
        description: flag of suggest search (clicked from suggest below the input)
      - name: search_or_catalog_flg
        description: indicator of search or catalog type of event
      - name: platform
        description: device platform
      - name: is_not_robot_flg
        description: flag of the robot device (based on the device_stats.preview.total_num > 0 meaning the device actually seen products)
      - name: marketing_source
        description: marketing source of a device
      - name: product_id
        description: id of a touched (opened, added to cart, ordered) product
      - name: product_name
        description: name of a touched (opened, added to cart, ordered) product
      - name: pzn
        description: pzn of a touched (opened, added to cart, ordered) product
      - name: is_sponsored
        description: flag of sposored product in the search (labeled as sponsored)
      - name: opening_event_id
        description: id of a product opening
      - name: adding_event_id
        description: id of a product adding
      - name: order_id
        description: id of a product order
      - name: order_before_products_price
        description: sum of before discounts product price (price * quantity)
      - name: order_products_price
        description: sum of product price (price * quantity)

  - name: onfy_source_campaign_funnels
    description: owner - andrewocean, aggregated dataset of sources previews, product openings, addings to cart and orders
    columns:
      - name: event_dt
        description: the date of the users searches
      - name: event_date
        description: tech date field for partitioning
      - name: source
        description: type of channel from the latest interaction in the user experience funnel based on the time (search, catalog, recommendation widget, banner, email, popup)
      - name: first_page
        description: source screen or page where preview was loaded
      - name: placement
        description: search query or category name, recommendation_type for recommendations, pzn for email, product_id for popup
      - name: placement_pzn
        description: pzn, where recommendation was placed at, email led to, and popup was open at
      - name: campaign_name
        description: promo_key from product preview event, block_name from banner, utm_campaign from campaign
      - name: product_id
        description: id of a touched (previewed, opened, added, ordered) product
      - name: product_name
        description: name of a touched (previewed, opened, added, ordered) product
      - name: pzn
        description: pzn of a touched (previewed, opened, added, ordered) product
      - name: manufacturer
        description: manufacturer of a touched (previewed, opened, added, ordered) product
      - name: previews
        description: number of product previews of specific product within the mentioned sources
      - name: openings
        description: number of detailed product page openings of specific product within the mentioned sources
      - name: addings
        description: number of product addings to cart of specific product within the mentioned sources
      - name: order_id
        description: id of an order with specific product included (needed for recalculations within different filter set)
      - name: order_products_price
        description: sum of products price in this order for this product (there are may be 2+ packages with diff quantity of a product for diff price)
      - name: order_before_products_price
        description: sum of gmv (before products price) in this order for this product (there are may be 2+ packages with diff quantity of a product for diff price)
      - name: order_quantity
        description: number of packs bought in this order for this product
        
  - name: onfy_product_analogues
    description: owner - andrewocean, the table has a list of not prescribed current products from active pharmacies with their analogues; product analogues calculates based on medicine_ingredient table – the same quantity, unit and dosage form
    columns:
      - name: product_id
        description: main product id
      - name: product_pzn
        description: main product pzn
      - name: product_name
        description: main product name
      - name: product_package_size
        description: main product package size as quantity and units
      - name: product_manufacturer
        description: main product manufacturer as short name
      - name: product_min_price
        description: main product price as minimal price at onfy at the moment
      - name: analogue_id
        description: analogue product id
      - name: analogue_pzn
        description: analogue product pzn
      - name: analogue_name
        description: analogue product name
      - name: analogue_package_size
        description: analogue product package size as quantity and units
      - name: analogue_manufacturer
        description: analogue product manufacturer as short name
      - name: analogue_min_price
        description: analogue product price as minimal price at onfy at the moment

  - name: onfy_products_daily_visits_orders
    description: owner - andrewocean, the table has a list of not prescribed current products with the number of visits and orders by date for the last 730 days
    columns:
      - name: product_id
        description: product id
      - name: pzn
        description: pzn
      - name: product_name
        description: product name
      - name: package_size
        description: product package size as quantity and units
      - name: manufacturer
        description: product manufacturer as short name
      - name: dt
        description: the date of numbers based on order_created_time_cet for orders and event_ts_cet for events
      - name: visits
        description: productOpen events number from device_events mart 
      - name: orders
        description: number of unique order_id from orders_info mart
      - name: ordered_items
        description: sum of quantity of ordered product from orders_info mart
      - name: before_products_price
        description: sum of GMV based on before_products_price of ordered products from orders_info mart

  - name: onfy_marketing_channel_products_onfy_stats
    description: owner - helbuk, the table is used mainly for Price Comparison Dashboard (PhAn-1029). Grain 1 row per - product_id  x date x channel. Only for products with more than 100 orders in the past year. In general, data is gathered for the past 90 days.
    columns: 
      - name: product_id
        description: primary key
      - name: channel
        description: primary key. Same as in pharmacy.marketing_channel_price_fast_scd2
      - name: date
        description: primary key. Date comes from the effective_ts timestamp in the pharmacy.marketing_channel_price_fast_scd2
      - name: day_of_week
        description: Name of the weekday (e.g. "Tuesday")
      - name: month_name
        description: Name of the month (e.g. "August")
      - name: product_name
        description: Product name as in pharmacy_landing.product.name
      - name: num_total_orders
        description: Total Onfy orders for product historically (CURRENT_DATE() - INTERVAL 366 DAY)
      - name: mean_onfy_price
        description:  Onfy competitive price. Grain - product_id, channel, effective_ts (Min per grain)
      - name: mean_onfy_rank
        description:  Onfy competitive position. Grain - product_id, channel, effective_ts (normalized to the start of the hour as in marketing_channel_price_fast_scd2). Higher rank - lower price at Price Comparison Website.  
      - name: min_competitors_price_of_the_day
        description: Min Competitors' Price that day
      - name: mean_competitors_price
        description: Mean Competitors' Price that day
      - name: mean_competitors_price_25_percentile
        description: Mean Competitors' Price of the 25th Percentile
      - name: mean_competitors_price_median
        description: Mean Competitors' Price of the Median 
      - name: mean_competitors_price_75_percentile
        description: Mean Competitors' Price of the 75th Percentile 
      - name: mean_first_rank_price
        description: Mean Competitors' Price of the First Rank
      - name: mean_second_rank_price
        description: Mean Competitors' Price of the Second Rank
      - name: mean_third_rank_price
        description: Mean Competitors' Price of the Third Rank
      - name: pharmacy_name_set
        description: Set of competitors' names that day
      - name: sum_gross_profit_initial_onfy
        description: GP initial based on visits from price aggregators (from ads_dashboard, source IN ('billiger', 'idealo', 'medizinfuchs'))
      - name: visits_from_pa 
        description: Visits from price aggregators (from ads_dashboard, source IN ('billiger', 'idealo', 'medizinfuchs'))
      - name: orders
        description: Orders based on visits from price aggregators (from ads_dashboard, source IN ('billiger', 'idealo', 'medizinfuchs'))
      - name: num_competitors
        description: Count of distinct competitors that day

  - name: onfy_marketing_channel_products_onfy_stats_new
    description: owner - helbuk, THE MODEL WITH UPDATED SOURCE marketing_channel_price_fast_v2_scd2 V2-VERSION. the table is used mainly for Price Comparison Dashboard (PhAn-1029). Grain 1 row per - product_id  x date x channel. Only for products with more than 100 orders in the past year. In general, data is gathered for the past 90 days.
    columns: 
      - name: product_id
        description: primary key
      - name: channel
        description: primary key. Same as in pharmacy.marketing_channel_price_fast_v2_scd2
      - name: date
        description: primary key. Date comes from the effective_ts timestamp in the pharmacy.marketing_channel_price_fast_v2_scd2
      - name: day_of_week
        description: Name of the weekday (e.g. "Tuesday")
      - name: month_name
        description: Name of the month (e.g. "August")
      - name: product_name
        description: Product name as in pharmacy_landing.product.name
      - name: num_total_orders
        description: Total Onfy orders for product historically (CURRENT_DATE() - INTERVAL 366 DAY)
      - name: mean_onfy_price
        description:  Onfy competitive price. Grain - product_id, channel, effective_ts (Min per grain)
      - name: mean_onfy_rank
        description:  Onfy competitive position. Grain - product_id, channel, effective_ts (normalized to the start of the hour as in marketing_channel_price_fast_v2_scd2). Higher rank - lower price at Price Comparison Website.  
      - name: min_competitors_price_of_the_day
        description: Min Competitors' Price that day
      - name: mean_competitors_price
        description: Mean Competitors' Price that day
      - name: mean_competitors_price_25_percentile
        description: Mean Competitors' Price of the 25th Percentile
      - name: mean_competitors_price_median
        description: Mean Competitors' Price of the Median 
      - name: mean_competitors_price_75_percentile
        description: Mean Competitors' Price of the 75th Percentile 
      - name: mean_first_rank_price
        description: Mean Competitors' Price of the First Rank
      - name: mean_second_rank_price
        description: Mean Competitors' Price of the Second Rank
      - name: mean_third_rank_price
        description: Mean Competitors' Price of the Third Rank
      - name: pharmacy_name_set
        description: Set of competitors' names that day
      - name: sum_gross_profit_initial_onfy
        description: GP initial based on visits from price aggregators (from ads_dashboard, source IN ('billiger', 'idealo', 'medizinfuchs'))
      - name: visits_from_pa 
        description: Visits from price aggregators (from ads_dashboard, source IN ('billiger', 'idealo', 'medizinfuchs'))
      - name: orders
        description: Orders based on visits from price aggregators (from ads_dashboard, source IN ('billiger', 'idealo', 'medizinfuchs'))
      - name: num_competitors
        description: Count of distinct competitors that day

  
  - name: onfy_marketing_channel_popular_competitors
    description: owner - helbuk, the table is used mainly for Price Comparison Dashboard (PhAn-1029). Grain - channel x pharmacy_name. Summarizes competitor pharmacies’ price positioning on price-comparison channels over the last ~90 days. product_id must be in Onfy’s set with ≥ 100 orders in the last 366 days (all stores combined)
    columns: 
      - name: channel
        description: Price comparison channel (e.g., idealo, billiger, medizinfuchs-api) as in pharmacy.marketing_channel_price_fast_scd2
      - name: pharmacy_name
        description:  Competitor pharmacy name  as in pharmacy.marketing_channel_price_fast_scd2
      - name: num_products
        description: Distinct product_id with non-null price for this pharmacy on this channel.
      - name: num_products_onfy_intersections
        description: Distinct products where both this pharmacy and Onfy were ranked in top-N (usually top-3) 
      - name: onfy_price_comparison
        description: Mean relative gap to Onfy across intersections -  AVG((competitor − Onfy) / Onfy).
      - name: mean_rank
        description: Average DENSE_RANK of the pharmacy per product_id x channel x date (1=cheapest).
      - name: mean_price
        description: Basic price level stats across all daily observations.
      - name: min_price
        description: Basic price level stats across all daily observations.
      - name: max_price
        description: Basic price level stats across all daily observations.
      - name: percentile_25_price
        description: Price distribution percentiles.
      - name: percentile_75_price
        description: Price distribution percentiles.
      - name: median_price
        description: Price distribution percentiles.
      - name: std_price
        description: Standard deviation of prices (volatility).
      - name: num_dates_stats
        description: Number of unique date values contributing to the stats (how many distinct days pharmacy had offers).
  

  - name: onfy_marketing_channel_popular_competitors_new
    description: owner - helbuk, THE MODEL WITH UPDATED SOURCE marketing_channel_price_fast_v2_scd2 V2-VERSION. The table is used mainly for Price Comparison Dashboard (PhAn-1029). Grain - channel x pharmacy_name. Summarizes competitor pharmacies’ price positioning on price-comparison channels over the last ~90 days. product_id must be in Onfy’s set with ≥ 100 orders in the last 366 days (all stores combined)
    columns: 
      - name: channel
        description: Price comparison channel (e.g., idealo, billiger, medizinfuchs-api) as in pharmacy.marketing_channel_price_fast_v2_scd2
      - name: pharmacy_name
        description:  Competitor pharmacy name  as in pharmacy.marketing_channel_price_fast_v2_scd2
      - name: num_products
        description: Distinct product_id with non-null price for this pharmacy on this channel.
      - name: num_products_onfy_intersections
        description: Distinct products where both this pharmacy and Onfy were ranked in top-N (usually top-3) 
      - name: onfy_price_comparison
        description: Mean relative gap to Onfy across intersections -  AVG((competitor − Onfy) / Onfy).
      - name: mean_rank
        description: Average DENSE_RANK of the pharmacy per product_id x channel x date (1=cheapest).
      - name: mean_price
        description: Basic price level stats across all daily observations.
      - name: min_price
        description: Basic price level stats across all daily observations.
      - name: max_price
        description: Basic price level stats across all daily observations.
      - name: percentile_25_price
        description: Price distribution percentiles.
      - name: percentile_75_price
        description: Price distribution percentiles.
      - name: median_price
        description: Price distribution percentiles.
      - name: std_price
        description: Standard deviation of prices (volatility).
      - name: num_dates_stats
        description: Number of unique date values contributing to the stats (how many distinct days pharmacy had offers).
    
  - name: banners_stats
    description: owner - helbuk, For the Dashboard "Promo Campaign Statistics" (PhAn-968). Collects shows, clicks, orders, gmv and number of purchased packages produced by banners (different SourceScreens). Grain - partition_date_cet, sourceScreen, promo_type, blockName. Data is gathered for the past 3 months. 
    columns: 
      - name: partition_date_cet
        description: Day of event - partition_date_cet from onfy_mart.device_events
      - name: sourceScreen
        description:  Screen where banner was displayed (home, search, product, etc)
      - name: promo_type
        description: Here it is always 'banner'
      - name: blockName
        description: Banner identificator (banner_catalog_dermasense, banner_home_00565096 etc)
      - name: impressions
        description: Number of times banner was shown
      - name: clicks
        description: Number of banner-clicks
      - name: orders
        description: Number of placed (attributed) orders
      - name: gmv
        description: Gross merchandise value of attributed orders - SUM(products_price)
      - name: packs_sold
        description: Number of packs purchased in attributed orders

  - name: catalogs_stats
    description: owner - helbuk, For the Dashboard "Promo Campaign Statistics" (PhAn-968). This model measures sponsored product performance inside catalogs. Collects shows, clicks, orders, gmv and number of purchased packages. Grain - partition_date_cet, promoKey, pzn, categoryId, categoryName. Data is gathered for the past 3 months. 
    columns: 
      - name: partition_date_cet
        description: Day of event - partition_date_cet from onfy_mart.device_events
      - name: promoKey
        description:  Internal key identifying sponsored campaign (e.g. 'hager', 'cooper' etc)
      - name: pzn
        description: Product code (identifier of promoted product)
      - name: categoryId
        description: E.g 'd89eae8ccd99454296b6a38a100f49be'
      - name: categoryName
        description: E.g. 'Arzneimittel'
      - name: impressions
        description: Product previews inside catalog (sponsored slots with promoKey)
      - name: clicks
        description: Number of clicks to sponsored products
      - name: orders
        description: Number of placed (attributed) orders
      - name: gmv
        description: Gross merchandise value of attributed orders - SUM(products_price)
      - name: packs_sold
        description: Number of packs purchased in attributed orders

  - name: recommendations_stats
    description: owner - helbuk, For the Dashboard "Promo Campaign Statistics" (PhAn-968). This model measures the performance of sponsored products shown in recommendation widgets across different source screens. Collects shows, clicks, orders, gmv and number of purchased packages. Grain - partition_date_cet, promoKey, pzn, categoryId, categoryName. Data is gathered for the past 3 months. 
    columns: 
      - name: partition_date_cet
        description: Day of event - partition_date_cet from onfy_mart.device_events
      - name: promoKey
        description:  Internal key identifying sponsored campaign (e.g. 'pharmasgp' etc)
      - name: sourceScreen
        description: Screen, where recommendation was displayed (home, product, etc)
      - name: pzn
        description: Product code (identifier of promoted product)
      - name: recommendationType
        description: E.g 'pr_also_bought_type'
      - name: recommendationSlotName
        description: E.g. 'slot4'
      - name: impressions
        description: Sponsored Product previews inside recommendations 
      - name: clicks
        description: Number of clicks to sponsored products
      - name: orders
        description: Number of placed (attributed) orders
      - name: gmv
        description: Gross merchandise value of attributed orders - SUM(products_price)
      - name: packs_sold
        description: Number of packs purchased in attributed orders

  - name: feed_loaders_stats_per_pharmacy
    description: PB-8552 - there is ticket to check issues with root table, might not be safe to use

  - name: pzns_out_of_stock
    description: owner - helbuk (PhAn-933). Grain -  store_name x pzn. StatWindow = 90 days — performance baseline window. It estimates how many days a product was unavailable, current OOS status, GMV lost on OOS days (last 30d), and the product’s expected GMV per active day to project weekly/monthly impact.
    columns: 
      - name: store_name
        description: as in pharmacy_landing.store
      - name: pzn
        description: Product code (country_local_id).
      - name: title
        description: Product name as in pharmacy_landing.product.name 
      - name: days_not_active_total
        description: Total OOS days in the last 30d (duration sum).
      - name: days_not_active_now
        description: OOS days in last 30d accumulated for the most recent OOS state (indicates currently OOS).
      - name: gmv_per_active_day
        description: Expected GMV per day when the item is in stock (computed from 90d baseline).
      - name: avg_item_price
        description: Average item price across baseline orders (uses before_price if present).
      - name: lost_gmv_total
        description: Sum of realized daily GMV on days that were OOS in last 30d (proxy for unmet demand).
      - name: lost_gmv_avg_per_day
        description: lost_gmv_total / days_not_active_total.
      - name: gmv_per_active_week
        description: 7 x gmv_per_active_day projection.
      - name: gmv_per_active_month
        description: 30 x gmv_per_active_day projection.
        
  - name: transactions
    description: |
      owner - annzaychik, enriched parcel-level transactions with PSP fees and currency expansion (EUR + USD). Grain — 1 row per transaction type × parcel_id × currency.
      Includes GMV and Gross Profit in initial and final variants.
      Pre–2023-07-21 PSP fees are synthesized; USD values are converted via mart.dim_currency_rate.
      Final output is a UNION of EUR and USD records and distributed by partition_date.
    columns:
      - name: type
        description: "normalized transaction type (e.g., PAYMENT, ORDER_SHIPMENT, DISCOUNT, COMMISSION, CHARGE_FEE, REFUND_FEE, *_REVERSAL, *_VAT)"
      - name: order_id
        description: "unique order identifier"
      - name: purchase_num
        description: "sequential purchase index per user_email_hash (1 = first purchase)"
      - name: device_id
        description: "device identifier from pharmacy_landing.order"
      - name: app_device_type
        description: "device category (WEB_DESKTOP / WEB_MOBILE / IOS / ANDROID / Other)"
      - name: platform_type
        description: "WEB / APP / Other derived from app_type"
      - name: order_parcel_id
        description: "parcel identifier for shipment-related transactions (nullable)"
      - name: store_name
        description: "pharmacy/store name linked via order_parcel (nullable)"
      - name: payment_method
        description: "payment method used on the order (e.g., PAY_PAL, CARD, APPLE_PAY, GIROPAY, SOFORT, KLARNA)"
      - name: user_email_hash
        description: "hashed user email for attribution and purchase_num derivation"
      - name: source
        description: "last-touch marketing source from lndc_user_attribution"
      - name: campaign
        description: "last-touch marketing campaign from lndc_user_attribution"
      - name: order_created_time_cet
        description: "order created timestamp converted to Europe/Berlin (from pharmacy_landing.order)"
      - name: transaction_date
        description: "transaction timestamp in CET (Europe/Berlin); for synthesized PSP rows equals order_created_time_cet"
      - name: partition_date
        description: "DATE(transaction_date) used for partitioning"
      - name: price
        description: |
          signed transaction amount in the given currency (see currency).
          PSP fees before 2023-07-21 are calculated per payment_method using fixed + % of turnover for charges,
          and fixed + % of refund for refunds, then inserted as CHARGE_FEE/REFUND_FEE.
      - name: currency
        description: |
          currency code of the row (EUR or USD).
          USD rows are produced by multiplying EUR amounts by (EUR rate / USD rate) from mart.dim_currency_rate on transaction_date.
      - name: gmv_initial
        description: "raw positive GMV components only (PAYMENT, SERVICE_FEE, ORDER_SHIPMENT, DELIVERY_SURCHARGE)"
      - name: gmv_final
        description: "net GMV including reversals (positive for charges, negative for *_REVERSAL)"
      - name: gross_profit_initial
        description: "initial GP components (COMMISSION, SERVICE_FEE, DELIVERY_SURCHARGE, MEDIA_REVENUE) minus VAT/DISCOUNT/CHARGE_FEE components"
      - name: gross_profit_final
        description: "net GP after reversals and refund fees (adds *_REVERSAL_* and REFUND_FEE, subtracts *_VAT, DISCOUNT, CHARGE_FEE)"
