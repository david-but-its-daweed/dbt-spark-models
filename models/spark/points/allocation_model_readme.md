%md

## Описание модели, которая полечит все на свете

Задача, которую решает модель: аллокация начисленных пользователям баллов по каналам их списания (трата на покупки, сгорание или NULL, что значит, что баллы всё ещё активны). Это нужно для того, чтобы точно отвечать на вопрос, какая судьба постигла баллы, разданные маркетингом: сколько пользователи успели потратить, а сколько сгорело или потенциально сгорит. Ответ на такой вопрос позволяет точнее учесть баллы в PnL.

На данный момент нет технической возможности определять это со 100%-ной точностью вследствие особенности работы бекенда. Поэтому считаем приблизительно, но достаточно точно.

Алгоритм приблизительного расчета, используемый в модели (для объяснения упрощаем условие: хотим посчитать аллокацию баллов, начисленных юзерам в декабре 2024г):
1. Считаем для каждого юзера его совокупный доход баллов в разбивке по типам за декабрь 2024г. Совокупный доход состоит из:
- начислений за маркетинг
- начислений за рефанды
- начислений в качестве компенсаций
- начислений за остальное (должно составлять <1%)
2. Считаем для каждого юзера его актуальный баланс на момент начала расчетного периода (то есть что было до декабря 2024г - назовем это "запас в зимней куртке")
3. Считаем также для каждого юзера его списания баллов с декабря 2024 и по сегодняшний день. Вида списаний 3:
- траты
- сгорания
- остальное (должно составлять <1%)
4. Определяем судьбу баллов юзера, выданных ему в декабре. Это основное место, дающее погрешность расчета: мы по сути заявляем, что эти типы начислений равноценны (хотя на самом деле они различаются сроками сгорания). Но как показал ресерч (https://analytics.joom.ai/zeppelin/#/notebook/2KM5SXST8), пользователей с несколькими типами баллов не так уж и много; к тому же для них модель хоть и будет врать, но не критично. Баллы по итогу распределяются по 3 составляющим: X% сгорело, Y% потратилось и Z% осталось на счету (причем X+Y+Z=100%).

Логика алгоритма такая: если за декабрь было начислено X баллов, и списаний в будущем было больше, чем был баланс до начисления текущей транзакции X, то значит какую-то часть баллов X юзер потратит. Какую именно часть - зависит от того, насколько списаний в будущем больше, чем баланс. Если списаний сильно больше - значит потратит всё. А если списаний меньше, чем баланс до начисления X, значит на тех будущуих списаниях юзер тратит прошлый баланс, а X остается нетронутым.

5. По итогам распределения получаем для каждого юзера такое распределение (пример):
    - начисления за маркетинг: было 100, потратили 20, сгорело 40, осталось 30
    - начисления за рефанды: было 10, потратили 2, сгорело 4, осталось 3
    - начисления в качестве компенсаций: было 20, потратили 4, сгорело 8, осталось 6
    - начисления за остальное: было 0, потратили 0, сгорело 0, осталось 0
    - запас в зимней куртке: было 200, потратили 40, сгорело 80, осталось 60
6. Для блока "осталось" строим предикт - как скорее всего распределятся эти баллы в будущем. В первой версии это будет пропорция между purchase и expiration за последние 4 месяца.
7. Суммируем распределенные начислений и остатков по всем юзерам

Обобщаем этот алгоритм, рассчитывая каждый период на протяжении последнего года в трех скейлах: день, неделя, месяц.